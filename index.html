<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Biglietto ‚Äì NPC</title>

  <style>
    :root{
      --card-w: 380px;
      --radius: 26px;
      --glass: rgba(0,0,0,.35);
      --text: #fff;
      --muted: rgba(255,255,255,.85);
      --btn: rgba(255,255,255,.90);
      --btnText:#111;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background:#000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
    }

    .card{
      width:min(var(--card-w), 92vw);
      height: 760px;
      border-radius: var(--radius);
      overflow:hidden;
      position:relative;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      background: #111 url("card.png") center/cover no-repeat;
    }

    /* leggera ‚Äúcornice‚Äù scura */
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.08), rgba(0,0,0,.55));
      pointer-events:none;
    }

    .topBox{
      position:absolute;
      left:18px; right:18px; top:18px;
      padding:18px 18px 14px 18px;
      border-radius: 18px;
      background: var(--glass);
      backdrop-filter: blur(6px);
    }

    .msg{
      margin:0;
      line-height:1.35;
      font-size:15px;
      color:var(--muted);
      white-space:pre-line;
    }

    .saluto{
      margin:14px 0 0 0;
      font-weight:700;
      font-size:16px;
      color:#fff;
    }

    .btn{
      width:100%;
      margin-top:14px;
      border:0;
      border-radius: 14px;
      padding:12px 14px;
      background: var(--btn);
      color: var(--btnText);
      font-size:15px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .05s ease;
    }
    .btn:active{ transform: scale(.99); }

    /* Cerchio ‚Äúminimo‚Äù (avatar invisibile) */
    .orbWrap{
      position:absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display:grid;
      place-items:center;
      gap:10px;
      text-align:center;
      width: 220px;
      pointer-events:none; /* di default non blocca click */
    }
    .orb{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 0 rgba(255,255,255,.35);
      opacity:.8;
    }
    .orb.talking{
      animation: pulse 1.15s ease-in-out infinite;
      background: rgba(255,255,255,.65);
    }
    @keyframes pulse{
      0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,255,255,.38); opacity:.65; }
      55%  { transform: scale(1.9); box-shadow: 0 0 0 16px rgba(255,255,255,.0); opacity:1; }
      100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(255,255,255,.0); opacity:.65; }
    }

    .orbHint{
      font-size:12px;
      color: rgba(255,255,255,.8);
    }

    /* Zona microfono: rendiamola cliccabile senza ‚Äúavatar‚Äù */
    .micPad{
      position:absolute;
      left:0; right:0;
      top: calc(50% - 90px);
      height: 180px;
      /* area cliccabile invisibile */
      background: transparent;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .micPad .tapLabel{
      position:absolute;
      bottom:10px;
      font-size:12px;
      color: rgba(255,255,255,.75);
      background: rgba(0,0,0,.35);
      padding:6px 10px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    .bottomBox{
      position:absolute;
      left:18px; right:18px; bottom:18px;
      padding:16px;
      border-radius: 18px;
      background: var(--glass);
      backdrop-filter: blur(6px);
    }

    .label{
      margin:0 0 10px 0;
      font-size:13px;
      color: rgba(255,255,255,.9);
      line-height:1.3;
    }

    textarea{
      width:100%;
      min-height: 88px;
      resize:none;
      border-radius: 14px;
      border:0;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    .btnSmall{
      flex:1;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      background: var(--btn);
      color: var(--btnText);
      font-size:15px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    .status{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.8);
      min-height: 16px;
    }
  </style>
</head>

<body>
  <div class="card" role="application" aria-label="Biglietto di auguri con NPC">

    <div class="topBox">
      <p class="msg">Questo √® un saluto di gratitudine.
Non per un ruolo soltanto,
ma per la presenza, la responsabilit√†
e il segno lasciato nel tempo.</p>

      <div class="saluto">Buon Natale</div>

      <button class="btn" id="btnPlayGreeting" type="button" aria-label="Ascolta il messaggio">
        üéß <span>Ascolta il messaggio</span>
      </button>
    </div>

    <!-- area microfono (premi e tieni premuto per parlare) -->
    <div class="micPad" id="micPad" title="Tieni premuto per parlare">
      <div class="tapLabel">Tieni premuto qui per parlare</div>
    </div>

    <!-- cerchietto (segnale minimale mentre l‚ÄôNPC parla) -->
    <div class="orbWrap" aria-hidden="true">
      <div class="orb" id="orb"></div>
      <div class="orbHint" id="orbHint">Voce di gratitudine</div>
    </div>

    <div class="bottomBox">
      <p class="label">Se lo desidera, pu√≤ lasciare un pensiero personale.</p>

      <textarea id="userText" placeholder="Scriva qui il suo pensiero..."></textarea>

      <div class="row">
        <button class="btnSmall" id="btnSendText" type="button">
          ‚úâÔ∏è <span>Affida il pensiero alla voce</span>
        </button>
      </div>

      <div class="status" id="status"></div>
    </div>
  </div>

  <script type="module">
    import { ConvaiClient } from "https://esm.sh/convai-web-sdk";

    // ====== CONFIG ======
    const CHARACTER_ID = "159ede3c-e0a9-11f0-a2da-42010a7be027";
    const CONVAI_API_KEY = "6d17b994bb7ae91ed23ec7002e11e72f"; // <- sostituisci con la tua API Key
    // ====================

    const orb = document.getElementById("orb");
    const orbHint = document.getElementById("orbHint");
    const statusEl = document.getElementById("status");
    const userTextEl = document.getElementById("userText");

    const btnPlayGreeting = document.getElementById("btnPlayGreeting");
    const btnSendText = document.getElementById("btnSendText");
    const micPad = document.getElementById("micPad");

    function setStatus(t){ statusEl.textContent = t || ""; }

    // Inizializza Convai
    const convai = new ConvaiClient({
      apiKey: CONVAI_API_KEY,
      characterId: CHARACTER_ID,
      enableAudio: true,
      // sessionId: "optional-session-id",
      // disableAudioGeneration: false,
    });

    // Callback risposte (testo + audio)
    convai.setResponseCallback((response) => {
      // user transcript (se vuoi mostrarlo)
      if (response.hasUserQuery?.()) {
        const transcript = response.getUserQuery();
        if (transcript?.getIsFinal?.()) {
          // puoi leggere transcript.getTextData()
        }
      }
      // NPC audio/text
      if (response.hasAudioResponse?.()) {
        const audioResponse = response.getAudioResponse();
        const t = audioResponse?.getTextData?.() || "";
        if (t) setStatus("NPC: " + t);
      }
    });

    // ‚ÄúSegnale minimo‚Äù quando parla
    convai.onAudioPlay(() => {
      orb.classList.add("talking");
      orbHint.textContent = "Sta parlando‚Ä¶";
    });

    convai.onAudioStop(() => {
      orb.classList.remove("talking");
      orbHint.textContent = "Voce di gratitudine";
    });

    // 1) Bottone: messaggio ‚Äúpredefinito‚Äù
    btnPlayGreeting.addEventListener("click", () => {
      setStatus("Invio del messaggio‚Ä¶");
      convai.sendTextChunk(
        "Leggi ad alta voce, con tono elegante e caloroso, il messaggio di gratitudine del biglietto."
      );
    });

    // 2) Bottone: invia il testo dell‚Äôutente
    btnSendText.addEventListener("click", () => {
      const txt = (userTextEl.value || "").trim();
      if (!txt) {
        setStatus("Scrivi prima un pensiero nel riquadro.");
        return;
      }
      setStatus("Invio del pensiero‚Ä¶");
      convai.sendTextChunk(txt);
    });

    // 3) Microfono: premi e tieni premuto (start/stop)
    let recording = false;

    const startRec = () => {
      if (recording) return;
      recording = true;
      setStatus("üéôÔ∏è Ti ascolto‚Ä¶ (rilascia per inviare)");
      convai.startAudioChunk();
      // piccolo feedback visivo (non √® ‚Äútalking‚Äù, √® ‚Äústo ascoltando‚Äù)
      orb.classList.add("talking");
      orbHint.textContent = "In ascolto‚Ä¶";
    };

    const stopRec = () => {
      if (!recording) return;
      recording = false;
      setStatus("Invio audio‚Ä¶");
      convai.endAudioChunk();
      orb.classList.remove("talking");
      orbHint.textContent = "Voce di gratitudine";
    };

    micPad.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      micPad.setPointerCapture?.(e.pointerId);
      startRec();
    });

    micPad.addEventListener("pointerup", (e) => {
      e.preventDefault();
      stopRec();
    });

    micPad.addEventListener("pointercancel", (e) => {
      e.preventDefault();
      stopRec();
    });

    // Suggerimento: invio con Enter (senza andare a capo)
    userTextEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        btnSendText.click();
      }
    });
  </script>
</body>
</html>







